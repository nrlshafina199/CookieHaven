<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cookie Catalog | CookieHaven</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f1e7;
            color: #5d4037;
            margin: 0;
        }

        header {
            background: #5d4037;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 40px;
            justify-content: center;
        }

        .product-card {
            background: white;
            border: 2px solid #5d4037;
            border-radius: 15px;
            padding: 20px;
            width: 250px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .qty-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .qty-btn {
            background: #8d6e63;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        .qty-input {
            width: 50px;
            text-align: center;
            border: 1px solid #5d4037;
            border-radius: 5px;
            padding: 5px;
        }

        .add-btn {
            background: #5d4037;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        .add-btn:hover {
            background: #3e2723;
        }

        #cart-status {
            background: #8d6e63;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
        }

        #cart-status:hover {
            background: #6d4c41;
        }

        .empty-message {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: #8d6e63;
        }
    </style>
</head>
<body>

<header>
    <h1>üç™ CookieHaven Catalog</h1>
    <a href="/cart.html" id="cart-status">üõí Cart (<span id="cart-count">0</span>)</a>
</header>

<main class="product-grid" id="product-container">
    <div class="empty-message">Loading delicious cookies...</div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadProducts();
        updateCartCount();
    });

    async function loadProducts() {
        const container = document.getElementById("product-container");

        try {
            const res = await fetch("/admin/products/api");

            if (!res.ok) {
                container.innerHTML = '<div class="empty-message">Failed to load products. Please try again.</div>';
                return;
            }

            const products = await res.json();

            if (products.length === 0) {
                container.innerHTML = '<div class="empty-message">No cookies available yet! Check back soon!</div>';
                return;
            }

            container.innerHTML = products.map(p => `
                <div class="product-card">
                    <h3>${p.name}</h3>
                    <p><i>${p.description}</i></p>
                    <p style="font-size: 0.8em; color: #777;">
                        <b>Contains:</b> ${p.allergens}<br>
                        <b>Ingredients:</b> ${p.ingredients}
                    </p>
                    <p style="font-size: 1.3em; color: #d84315; font-weight: bold;">RM ${p.price.toFixed(2)}</p>
                    <p>Stock: ${p.stock}</p>

                    <div class="qty-controls">
                        <button class="qty-btn" onclick="changeQty('${p.id}', -1)">‚àí</button>
                        <input type="number" class="qty-input" id="qty_${p.id}" value="1" min="1" readonly>
                        <button class="qty-btn" onclick="changeQty('${p.id}', 1)">+</button>
                    </div>

                    <button class="add-btn" onclick="addToCart('${p.id}')">Add to Cart</button>
                </div>
            `).join('');

        } catch (e) {
            console.error("Failed to load catalog:", e);
            container.innerHTML = '<div class="empty-message">Error loading catalog. Please refresh the page.</div>';
        }
    }

    function changeQty(id, delta) {
        const input = document.getElementById('qty_' + id);
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    async function addToCart(productId) {
        const qtyInput = document.getElementById('qty_' + productId);
        const qty = qtyInput.value;

        const params = new URLSearchParams();
        params.append("action", "add");
        params.append("productId", productId);
        params.append("quantity", qty);

        try {
            const res = await fetch("/api/cart", { method: "POST", body: params });
            const data = await res.json();

            if (data.success) {
                alert("‚úì Added to cart!");
                updateCartCount();
                qtyInput.value = 1; // Reset quantity
            }
        } catch (e) {
            alert("Failed to add to cart. Please try again.");
            console.error(e);
        }
    }

    async function updateCartCount() {
        try {
            const res = await fetch("/api/cart");
            const data = await res.json();
            const countEl = document.getElementById("cart-count");
            if (countEl) countEl.textContent = data.cartCount;
        } catch (e) {
            console.error("Failed to update cart count:", e);
        }
    }
</script>

</body>
</html>